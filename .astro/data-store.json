[["Map",1,2,9,10],"meta::meta",["Map",3,4,5,6,7,8],"astro-version","5.12.0","content-config-digest","1b6a4036413255aa","astro-config-digest","{\"root\":{},\"srcDir\":{},\"publicDir\":{},\"outDir\":{},\"cacheDir\":{},\"site\":\"https://www.holewinski.dev\",\"compressHTML\":true,\"base\":\"/\",\"trailingSlash\":\"ignore\",\"output\":\"static\",\"scopedStyleStrategy\":\"attribute\",\"build\":{\"format\":\"directory\",\"client\":{},\"server\":{},\"assets\":\"_astro\",\"serverEntry\":\"entry.mjs\",\"redirects\":true,\"inlineStylesheets\":\"auto\",\"concurrency\":1},\"server\":{\"open\":false,\"host\":false,\"port\":4321,\"streaming\":true,\"allowedHosts\":[]},\"redirects\":{},\"image\":{\"endpoint\":{\"route\":\"/_image\"},\"service\":{\"entrypoint\":\"astro/assets/services/noop\",\"config\":{}},\"domains\":[],\"remotePatterns\":[],\"layout\":\"constrained\",\"responsiveStyles\":true},\"devToolbar\":{\"enabled\":true},\"markdown\":{\"syntaxHighlight\":{\"type\":\"shiki\",\"excludeLangs\":[\"math\"]},\"shikiConfig\":{\"langs\":[],\"langAlias\":{},\"theme\":\"everforest-dark\",\"themes\":{},\"defaultColor\":false,\"wrap\":false,\"transformers\":[{},{\"name\":\"@shikijs/transformers:notation-highlight\"},{\"name\":\"@shikijs/transformers:notation-highlight-word\"},{\"name\":\"@shikijs/transformers:notation-diff\"}]},\"remarkPlugins\":[null,[null,{\"test\":\"Table of contents\"}]],\"rehypePlugins\":[],\"remarkRehype\":{},\"gfm\":true,\"smartypants\":true},\"security\":{\"checkOrigin\":true},\"env\":{\"schema\":{\"PUBLIC_GOOGLE_SITE_VERIFICATION\":{\"access\":\"public\",\"context\":\"client\",\"optional\":true,\"type\":\"string\"}},\"validateSecrets\":false},\"experimental\":{\"clientPrerender\":false,\"contentIntellisense\":false,\"headingIdCompat\":false,\"preserveScriptOrder\":true,\"liveContentCollections\":false,\"csp\":false,\"rawEnvValues\":false},\"legacy\":{\"collections\":false}}","posts",["Map",11,12,44,45],"making-google-blockly-actually-usable-because-good-grief",{"id":11,"data":13,"body":23,"filePath":24,"assetImports":25,"digest":27,"rendered":28},{"author":14,"pubDatetime":15,"github":16,"title":17,"featured":18,"draft":19,"tags":20,"description":22},"Tyler Holewinski",["Date","2026-01-03T03:52:58.281Z"],"https://github.com/erwijet/better-blockly","Google Blockly, but make it not terrible",true,false,[21],"others","Detailing my building of a better blockly definition system","Okay so I _really_ like [Blockly](https://developers.google.com/blockly). I'm going to be quite critical of it, but I think it's a fantastic project. I myself in my earliest programming years remember tinkering with [MIT's Scratch](https://scratch.mit.edu), so block-based programming will always hold a space in my heart.\n\nWhen I discovered the Blockly library, I was _so_ excited and had so many ideas of what to use it for. I had an 8 hour amtrak trip one weekend so I decided to dedicate my trip to getting a simple example working with Blockly, however I quickly realized the DX was an absolute nightmare. I knew I wanted to use Blockly for my [capstone project](https://ticoder.dev), but _really_ didn't want to deal with making **that** many blocks for my project.\n\n## Okay, so let me demonstrate the problem\n\nLet's say that we want to create just a handful of blocks.\n\n1. A simple \"math\" operator (+, -, \\*, /)\n2. An \"if\" statement, which takes a boolean and conditionally runs a block of code\n3. An \"if/else\", which is identical to the \"if\" statement but lets you run a block of code if the condition is false\n4. A \"literal\" block for each type (string, number, boolean)\n5. A numeric compare operator (\u003C, >, \u003C=, >=, ==, !=)\n6. A block that creates text output (like `alert()`, `console.log`, etc)\n\nSo Blockly has this [interactive playground](https://raspberrypifoundation.github.io/blockly-samples/examples/developer-tools/index.html) that they promote to let users _generate_ code for these block definitions. Let's take a look at it and create our first block, the \"math operator\".\n\n![better-blockly-fig-1](../../assets/images/better-blockly-fig-1.png)\n\nThis produces two notable pieces of codegen: the first is the **block definition**, and the second is **generator** code. What's notable is these two pieces of code are interdependent, but **not** colocated. This mean that a change to the block definition requires a change to the generator, but may not be immediately obvious to an incoming new developer on a project (or perhaps a developer like me who may have forgotten). This, along with just the general verbosity required to make a block, is what I wanted to set out to fix. Additionally, I find that needing to use a GUI like this is perhaps indicative of a larger DX issue-- especially when (and perhaps this is a skill issue) the GUI itself I find kinda cumbersome.\n\n```js file=generated-block-definition.js\nconst math_bin = {\n  init: function () {\n    this.appendValueInput(\"lhs\").setCheck(\"Number\");\n    this.appendDummyInput(\"op\").appendField(\n      new Blockly.FieldDropdown([\n        [\"+\", \"add\"],\n        [\"-\", \"sub\"],\n        [\"*\", \"mul\"],\n        [\"/\", \"div\"],\n      ]),\n      \"op\"\n    );\n    this.appendValueInput(\"rhs\").setCheck(\"Number\");\n    this.setInputsInline(true);\n    this.setOutput(true, \"Number\");\n    this.setTooltip(\"\");\n    this.setHelpUrl(\"\");\n    this.setColour(225);\n  },\n};\nBlockly.common.defineBlocks({ math_bin: math_bin });\n```\n\n```js file=generated-generator-definition.js\njavascriptGenerator.forBlock['math_bin'] = function() {\n  const value_lhs = generator.valueToCode(block, 'lhs', Order.ATOMIC);\n\n  const dropdown_op = block.getFieldValue('op');\n\n  const value_rhs = generator.valueToCode(block, 'rhs', Order.ATOMIC);\n\n  // TODO: Assemble javascript into the code variable.\n  const code = '...';\n  // TODO: Change Order.NONE to the correct operator precedence strength\n  return [code, Order.NONE];\n```\n\nFrom here, of course, we would need to go through and update our generator code accordingly:\n\n```js file=generated-generator-definition.js\njavascriptGenerator.forBlock[\"math_bin\"] = function (block) {\n  const value_lhs = generator.valueToCode(block, \"lhs\", Order.ATOMIC);\n\n  const dropdown_op = block.getFieldValue(\"op\");\n  // [!code ++:6]\n  const op = {\n    add: \"+\",\n    sub: \"-\",\n    mul: \"*\",\n    div: \"/\",\n  }[dropdown_op];\n\n  const value_rhs = generator.valueToCode(block, \"rhs\", Order.ATOMIC);\n\n  // [!code --:4]\n  // TODO: Assemble javascript into the code variable.\n  const code = \"...\";\n  // TODO: Change Order.NONE to the correct operator precedence strength\n  return [code, Order.NONE];\n\n  // [!code ++:1]\n  return `${value_lhs}${op}${value_rhs}`;\n};\n```\n\nHere, we can see our _next_ problem. This is all javascript, which means we don't really _know_ what the values of `dropdown_op` are. Now, looking at the definition we can see that it can only be one of four possible values, but because that definition is entirely separate from the generator code, we have no way of easily seeing that.\n\n## So anyway, let's make it typesafe and ergonomic\n\nWhat I really wanted to do was to create a utility that would let be express the blocks definition and implementation (generator) in one expression. This not only solves the colocating issues, but also means that we can easily get proper type inference into our fields. I'll skip to what I came up with as a sort of \"hook\" to keep you reading lol.\n\n```ts file=example.ts\nimport * as Blockly from \"blockly/core\";\nimport { createBlockBuilder } from \"better-blockly\";\n\nconst generator = new Blockly.Generator(\"demo\");\n\nconst block = createBlockBuilder({\n  Blockly,\n  generator,\n  customTypes: [\"boolean\"],\n});\n\nblock(\"math_bin\")\n  .inline()\n  .outputs(\"Number\") // \u003C- we get typesaftey here!\n  .slot(\"lhs\", { allow: \"Number\", content: v => v })\n  .slot(\"rhs\", {\n    allow: \"Number\",\n    content: v => v.dropdown(\"op\", [\"\u003C\", \">\", \"\u003C=\", \">=\"]),\n  });\n```\n\nThat's pretty cool huh-- this will take the passed `Blockly` instance and define a block named `\"math_bin\"` with all the same specifications as before. You may have noticed though that this is only the definition, not the implementation. This is where things get really nifty--\n\n```ts file=example.ts\nimport * as Blockly from \"blockly/core\";\nimport { createBlockBuilder } from \"better-blockly\";\n\nconst generator = new Blockly.Generator(\"demo\");\n\nconst block = createBlockBuilder({\n  Blockly,\n  generator,\n  customTypes: [\"boolean\"],\n});\n\nblock(\"math_bin\")\n  .inline()\n  .outputs(\"Number\") // \u003C- we get typesaftey here!\n  .slot(\"lhs\", { allow: \"Number\", content: v => v })\n  .slot(\"rhs\", {\n    allow: \"Number\",\n    content: v =>\n      v.dropdown(\"op\", {\n        add: \"+\",\n        sub: \"-\",\n        mul: \"*\",\n        div: \"/\",\n      }),\n  })\n  // [!code ++:1]\n  .impl(({ fields, resolve }) => {\n    return `${resolve(\"lhs\")}${fields.op}${resolve(\"rhs\")}`;\n  });\n```\n\nWe are able to known prior to runtime if a key in the implementation is misaligned with the definition because each time we define a slot or field in the definition, we encode both that key, as well as its values, and use them to help type the `impl` block!\n\n```ts\n.impl(({ fields, resolve }) => {\n  fields. // autocomplete shows: op\n  resolve( // autocomplete shows: \"lhs\" | \"rhs\"\n})\n```","src/data/posts/better-blockly.md",[26],"../../assets/images/better-blockly-fig-1.png","84fd68597e6038ba",{"html":29,"metadata":30},"\u003Cp>Okay so I \u003Cem>really\u003C/em> like \u003Ca href=\"https://developers.google.com/blockly\">Blockly\u003C/a>. I’m going to be quite critical of it, but I think it’s a fantastic project. I myself in my earliest programming years remember tinkering with \u003Ca href=\"https://scratch.mit.edu\">MIT’s Scratch\u003C/a>, so block-based programming will always hold a space in my heart.\u003C/p>\n\u003Cp>When I discovered the Blockly library, I was \u003Cem>so\u003C/em> excited and had so many ideas of what to use it for. I had an 8 hour amtrak trip one weekend so I decided to dedicate my trip to getting a simple example working with Blockly, however I quickly realized the DX was an absolute nightmare. I knew I wanted to use Blockly for my \u003Ca href=\"https://ticoder.dev\">capstone project\u003C/a>, but \u003Cem>really\u003C/em> didn’t want to deal with making \u003Cstrong>that\u003C/strong> many blocks for my project.\u003C/p>\n\u003Ch2 id=\"okay-so-let-me-demonstrate-the-problem\">Okay, so let me demonstrate the problem\u003C/h2>\n\u003Cp>Let’s say that we want to create just a handful of blocks.\u003C/p>\n\u003Col>\n\u003Cli>A simple “math” operator (+, -, *, /)\u003C/li>\n\u003Cli>An “if” statement, which takes a boolean and conditionally runs a block of code\u003C/li>\n\u003Cli>An “if/else”, which is identical to the “if” statement but lets you run a block of code if the condition is false\u003C/li>\n\u003Cli>A “literal” block for each type (string, number, boolean)\u003C/li>\n\u003Cli>A numeric compare operator (&#x3C;, >, &#x3C;=, >=, ==, !=)\u003C/li>\n\u003Cli>A block that creates text output (like \u003Ccode>alert()\u003C/code>, \u003Ccode>console.log\u003C/code>, etc)\u003C/li>\n\u003C/ol>\n\u003Cp>So Blockly has this \u003Ca href=\"https://raspberrypifoundation.github.io/blockly-samples/examples/developer-tools/index.html\">interactive playground\u003C/a> that they promote to let users \u003Cem>generate\u003C/em> code for these block definitions. Let’s take a look at it and create our first block, the “math operator”.\u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/images/better-blockly-fig-1.png&#x22;,&#x22;alt&#x22;:&#x22;better-blockly-fig-1&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>This produces two notable pieces of codegen: the first is the \u003Cstrong>block definition\u003C/strong>, and the second is \u003Cstrong>generator\u003C/strong> code. What’s notable is these two pieces of code are interdependent, but \u003Cstrong>not\u003C/strong> colocated. This mean that a change to the block definition requires a change to the generator, but may not be immediately obvious to an incoming new developer on a project (or perhaps a developer like me who may have forgotten). This, along with just the general verbosity required to make a block, is what I wanted to set out to fix. Additionally, I find that needing to use a GUI like this is perhaps indicative of a larger DX issue— especially when (and perhaps this is a skill issue) the GUI itself I find kinda cumbersome.\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"js\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> math_bin \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">  init\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#E67E80\"> function\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> ()\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">    this\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">appendValueInput\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"lhs\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">)\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">setCheck\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"Number\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">    this\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">appendDummyInput\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"op\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">)\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">appendField\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">      new\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> Blockly\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">FieldDropdown\u003C/span>\u003Cspan style=\"color:#D3C6AA\">([\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        [\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"+\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"add\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        [\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"-\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"sub\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        [\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"*\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"mul\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        [\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"/\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"div\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">      ]),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#DBBC7F\">      \"op\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    );\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">    this\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">appendValueInput\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"rhs\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">)\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">setCheck\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"Number\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">    this\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">setInputsInline\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#D699B6\">true\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">    this\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">setOutput\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#D699B6\">true\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"Number\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">    this\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">setTooltip\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">    this\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">setHelpUrl\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">    this\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">setColour\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#D699B6\">225\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">Blockly\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">common\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">defineBlocks\u003C/span>\u003Cspan style=\"color:#D3C6AA\">({ math_bin\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> math_bin });\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">generated-block-definition.js\u003C/span>\u003C/pre>\n\u003Cpre class=\"astro-code everforest-dark mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"js\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">javascriptGenerator\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">forBlock[\u003C/span>\u003Cspan style=\"color:#DBBC7F\">'math_bin'\u003C/span>\u003Cspan style=\"color:#D3C6AA\">] \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#E67E80\"> function\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">  const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> value_lhs\u003C/span>\u003Cspan style=\"color:#E69875\"> =\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> generator\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">valueToCode\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(block,\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> 'lhs'\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> Order\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">ATOMIC);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">  const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> dropdown_op\u003C/span>\u003Cspan style=\"color:#E69875\"> =\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> block\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">getFieldValue\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">'op'\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">  const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> value_rhs\u003C/span>\u003Cspan style=\"color:#E69875\"> =\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> generator\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">valueToCode\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(block,\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> 'rhs'\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> Order\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">ATOMIC);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289;font-style:italic\">  // TODO: Assemble javascript into the code variable.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">  const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> code\u003C/span>\u003Cspan style=\"color:#E69875\"> =\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> '...'\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289;font-style:italic\">  // TODO: Change Order.NONE to the correct operator precedence strength\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">  return\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> [code,\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> Order\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">NONE];\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">generated-generator-definition.js\u003C/span>\u003C/pre>\n\u003Cp>From here, of course, we would need to go through and update our generator code accordingly:\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark has-diff mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"js\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">javascriptGenerator\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">forBlock[\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"math_bin\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">] \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#E67E80\"> function\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (block)\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">  const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> value_lhs\u003C/span>\u003Cspan style=\"color:#E69875\"> =\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> generator\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">valueToCode\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(block,\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"lhs\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> Order\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">ATOMIC);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">  const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> dropdown_op\u003C/span>\u003Cspan style=\"color:#E69875\"> =\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> block\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">getFieldValue\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"op\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E69875\">  const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> op\u003C/span>\u003Cspan style=\"color:#E69875\"> =\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">    add\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"+\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">    sub\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"-\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">    mul\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"*\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">    div\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"/\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">  }[dropdown_op];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">  const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> value_rhs\u003C/span>\u003Cspan style=\"color:#E69875\"> =\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> generator\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">valueToCode\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(block,\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"rhs\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> Order\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">ATOMIC);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line diff remove\">\u003Cspan style=\"color:#859289;font-style:italic\">  // TODO: Assemble javascript into the code variable.\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff remove\">\u003Cspan style=\"color:#E69875\">  const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> code\u003C/span>\u003Cspan style=\"color:#E69875\"> =\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"...\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff remove\">\u003Cspan style=\"color:#859289;font-style:italic\">  // TODO: Change Order.NONE to the correct operator precedence strength\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff remove\">\u003Cspan style=\"color:#E67E80\">  return\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> [code,\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> Order\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">NONE];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E67E80\">  return\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> `\u003C/span>\u003Cspan style=\"color:#A7C080\">${\u003C/span>\u003Cspan style=\"color:#D3C6AA\">value_lhs\u003C/span>\u003Cspan style=\"color:#A7C080\">}${\u003C/span>\u003Cspan style=\"color:#D3C6AA\">op\u003C/span>\u003Cspan style=\"color:#A7C080\">}${\u003C/span>\u003Cspan style=\"color:#D3C6AA\">value_rhs\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003Cspan style=\"color:#DBBC7F\">`\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">};\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">generated-generator-definition.js\u003C/span>\u003C/pre>\n\u003Cp>Here, we can see our \u003Cem>next\u003C/em> problem. This is all javascript, which means we don’t really \u003Cem>know\u003C/em> what the values of \u003Ccode>dropdown_op\u003C/code> are. Now, looking at the definition we can see that it can only be one of four possible values, but because that definition is entirely separate from the generator code, we have no way of easily seeing that.\u003C/p>\n\u003Ch2 id=\"so-anyway-lets-make-it-typesafe-and-ergonomic\">So anyway, let’s make it typesafe and ergonomic\u003C/h2>\n\u003Cp>What I really wanted to do was to create a utility that would let be express the blocks definition and implementation (generator) in one expression. This not only solves the colocating issues, but also means that we can easily get proper type inference into our fields. I’ll skip to what I came up with as a sort of “hook” to keep you reading lol.\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">import\u003C/span>\u003Cspan style=\"color:#D699B6\"> *\u003C/span>\u003Cspan style=\"color:#E67E80\"> as\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> Blockly \u003C/span>\u003Cspan style=\"color:#E67E80\">from\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"blockly/core\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">import\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> { createBlockBuilder } \u003C/span>\u003Cspan style=\"color:#E67E80\">from\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"better-blockly\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> generator \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#E67E80\"> new\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> Blockly\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">Generator\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"demo\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> block \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#A7C080\"> createBlockBuilder\u003C/span>\u003Cspan style=\"color:#D3C6AA\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  Blockly,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  generator,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  customTypes\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> [\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"boolean\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">});\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">block\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"math_bin\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">  .\u003C/span>\u003Cspan style=\"color:#A7C080\">inline\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">  .\u003C/span>\u003Cspan style=\"color:#A7C080\">outputs\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"Number\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">) \u003C/span>\u003Cspan style=\"color:#859289;font-style:italic\">// &#x3C;- we get typesaftey here!\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">  .\u003C/span>\u003Cspan style=\"color:#A7C080\">slot\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"lhs\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, { allow\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"Number\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, \u003C/span>\u003Cspan style=\"color:#A7C080\">content\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> v \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> v })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">  .\u003C/span>\u003Cspan style=\"color:#A7C080\">slot\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"rhs\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    allow\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"Number\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">    content\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> v \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> v\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">dropdown\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"op\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, [\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"&#x3C;\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, \u003C/span>\u003Cspan style=\"color:#DBBC7F\">\">\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, \u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"&#x3C;=\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, \u003C/span>\u003Cspan style=\"color:#DBBC7F\">\">=\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">]),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  });\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">example.ts\u003C/span>\u003C/pre>\n\u003Cp>That’s pretty cool huh— this will take the passed \u003Ccode>Blockly\u003C/code> instance and define a block named \u003Ccode>\"math_bin\"\u003C/code> with all the same specifications as before. You may have noticed though that this is only the definition, not the implementation. This is where things get really nifty—\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark has-diff mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">import\u003C/span>\u003Cspan style=\"color:#D699B6\"> *\u003C/span>\u003Cspan style=\"color:#E67E80\"> as\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> Blockly \u003C/span>\u003Cspan style=\"color:#E67E80\">from\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"blockly/core\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">import\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> { createBlockBuilder } \u003C/span>\u003Cspan style=\"color:#E67E80\">from\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"better-blockly\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> generator \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#E67E80\"> new\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> Blockly\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">Generator\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"demo\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> block \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#A7C080\"> createBlockBuilder\u003C/span>\u003Cspan style=\"color:#D3C6AA\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  Blockly,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  generator,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  customTypes\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> [\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"boolean\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">});\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">block\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"math_bin\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">  .\u003C/span>\u003Cspan style=\"color:#A7C080\">inline\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">  .\u003C/span>\u003Cspan style=\"color:#A7C080\">outputs\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"Number\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">) \u003C/span>\u003Cspan style=\"color:#859289;font-style:italic\">// &#x3C;- we get typesaftey here!\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">  .\u003C/span>\u003Cspan style=\"color:#A7C080\">slot\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"lhs\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, { allow\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"Number\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, \u003C/span>\u003Cspan style=\"color:#A7C080\">content\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> v \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> v })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">  .\u003C/span>\u003Cspan style=\"color:#A7C080\">slot\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"rhs\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    allow\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"Number\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">    content\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> v \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">      v\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">dropdown\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"op\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        add\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"+\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        sub\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"-\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        mul\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"*\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        div\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"/\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">      }),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  })\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#859289\">  .\u003C/span>\u003Cspan style=\"color:#A7C080\">impl\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(({ fields, resolve }) \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">    return\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> `\u003C/span>\u003Cspan style=\"color:#A7C080\">${\u003C/span>\u003Cspan style=\"color:#A7C080\">resolve\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"lhs\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">)\u003C/span>\u003Cspan style=\"color:#A7C080\">}${\u003C/span>\u003Cspan style=\"color:#D3C6AA\">fields\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">op\u003C/span>\u003Cspan style=\"color:#A7C080\">}${\u003C/span>\u003Cspan style=\"color:#A7C080\">resolve\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"rhs\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">)\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003Cspan style=\"color:#DBBC7F\">`\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  });\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">example.ts\u003C/span>\u003C/pre>\n\u003Cp>We are able to known prior to runtime if a key in the implementation is misaligned with the definition because each time we define a slot or field in the definition, we encode both that key, as well as its values, and use them to help type the \u003Ccode>impl\u003C/code> block!\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"ts\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">impl\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(({ fields, resolve }) \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  fields\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#859289;font-style:italic\"> // autocomplete shows: op\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">  resolve\u003C/span>\u003Cspan style=\"color:#D3C6AA\">( \u003C/span>\u003Cspan style=\"color:#859289;font-style:italic\">// autocomplete shows: \"lhs\" | \"rhs\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">})\u003C/span>\u003C/span>\u003C/code>\u003C/pre>",{"headings":31,"localImagePaths":39,"remoteImagePaths":40,"frontmatter":41,"imagePaths":43},[32,36],{"depth":33,"slug":34,"text":35},2,"okay-so-let-me-demonstrate-the-problem","Okay, so let me demonstrate the problem",{"depth":33,"slug":37,"text":38},"so-anyway-lets-make-it-typesafe-and-ergonomic","So anyway, let’s make it typesafe and ergonomic",[26],[],{"author":14,"pubDatetime":42,"title":17,"slug":11,"featured":18,"draft":19,"description":22,"github":16},["Date","2026-01-03T03:52:58.281Z"],[26],"letting-the-world-know-what-im-listening-to-all-the-time",{"id":44,"data":46,"body":52,"filePath":53,"assetImports":54,"digest":56,"rendered":57},{"author":14,"pubDatetime":47,"github":48,"title":49,"featured":18,"draft":19,"tags":50,"description":51},["Date","2025-10-05T03:52:58.281Z"],"https://github.com/erwijet/spotipub","Recreating Discord's real-time Spotify presence for my website",[21],"Hear me talk about how I attempted to let the entire world know what I am listening to at any given point","So I'm not fully sure why, but I've always been big into music. It's a big part of who I am and I love sharing it with the world! I really loved Discord's Spotify integration feature that lets users share not just what they're listening to, but also where in the track they are.\n\nI have memories of seeing what my classmates were listening to and just getting a vibe for who people were that way. It was nifty to be in a server with a couple dozen strangers, and their miniplayers next to their name.\n\nSo when it came time to build out my own personal website, I thought it would be a nice touch if the strangers who visited found me, a stranger, with a miniplayer next to my name. Plus, if Discord integrated with Spotify then they must support it, right?\n\n...right?\n\n## Table of Contents\n\n## So I looked into the Spotify API and...\n\nThey don't! At least not for you and me. It turns out they don't support websockets?? or _anything_ real-time it seems. Spotify [has a partnership with discord to support this feature, but they do not expose it to regular developer accounts](https://community.spotify.com/t5/Spotify-for-Developers/Retrieve-song-through-websocket/td-p/5182782).\n\nI figured, however, it wouldn't be that challenging to just create a service that internally polled the current song endpoint and then pushed any relevant updates to connected clients over some sort of real-time protocol. I've been wanting to mess with [server sent events](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events) for a while now and took this as an opportunity to finally do something with them.\n\n## SSE? I haven't heard of that before what is it?\n\nWebsockets have a robust lifecycle that requires additional overhead and architecture to support its bidirectional communication functionalities. Server-sent Events, however, are UNIdirectional (as the name implies, its `server -> client` only). Setting up a SSE connection is as simple as a client making a `GET` request, and then responding with a `content-type` of `text/event-stream`. Then, the server simply periodically sends plain text data in the format of\n\n```\nevent:eventname\ndata:{\"hello\":\"world\"}\n\\n\n\\n\n```\n\nand that's it! SSE functionality is built into native browser functionality with the [EventSource API](https://developer.mozilla.org/en-US/docs/Web/API/EventSource).\n\n```js file=client.js\nconst es = new EventSource(\"https://myserver.com/path\");\nes.addEventListener(\"eventname\", data => {\n  console.log(data); // \u003C- data is { hello: \"world\" }!\n});\n```\n\nIt's so simple I implemented the server logic for it in just under [40 lines](https://github.com/erwijet/spotipub/blob/main/internal/sse/sse_writer.go), and I'm by no means a golang wizard so I'm sure there's an even easier implementation out there.\n\nI also kinda wanted a chance to play with golang channels / goroutines for no other reason than I think they're a really cool language feature and I haven't really had a solid use case for them yet, so I decided to build this project around them.\n\n## How it sort of works\n\nI used [this excellent Spotify API library](https://github.com/zmb3/spotify) for the actual interfacing with Spotify. What's nice about this is it gives us an existing data struct representing the Spotify current listening data `libspot.CurrentPlaying`.\n\nI first created a simple `Listener` structure which wrapped a `chan *libspot.CurrentPlaying` for us to send updates through. When a user connects to our `/sse` endpoint, I create a new listener struct for their session and register it to a global `Notifier` singleton.\n\n```go file=internal/playback/notifier.go\ntype Notifier struct {\n\tlisteners []Listener\n}\n\nfunc  (n *Notifier) NewListener() *Listener {\n    // -- snip --\n}\n\nfunc (n *Notifier) Cleanup() {\n    // -- snip --\n}\n\ntype Listener struct {\n\towner *Notifier\n\tCh    chan *libspot.CurrentlyPlaying\n}\n```\n\nI then created a primary background goroutine for the `Notifier` to poll Spotify. The initial implementation of this would just always forward that data to any connected client.\n\n```go file=internal/playback/notifier.go\nfunc (n *Notifier) notifyAll(data *libspot.CurrentlyPlaying) {\n    for _, l := range n.listeners {\n        go func() {\n            l.Ch \u003C- data\n        }\n    }\n}\n\nfunc (n *Notifier) Run() {\n    client := WaitForClient()\n\n    for {\n        data, err := client.PlayerCurrentlyPlaying(context.Background())\n        if err != nil {\n            log.Printf(\"Failed to poll playback: %v\", err)\n            time.Sleep(5 * time.Second)\n            return\n        }\n\n        n.notifyAll(data)\n    }\n}\n```\n\nNow there is a case where because we are just always firing into `l.Ch` and aren't buffering anything, things could get a bit blocked. However, I'm comfortable with this tradeoff because of the scale of this project and number of active sessions I'm expecting to have.\n\nI also went through and added an auth flow to initialize the shared Spotify API client object, but that's not super interesting so I'll omit much of it from this. I had a basic working implementation\n\n```go file=main.go\n\nfunc main() {\n    n := playback.NewNotifier()\n    mux := http.NewServeMux()\n\n    go n.Run() // this runs our loop in the background\n    playback.BeginAuthFlow() // again, don't worry about this\n\n    mux.HandleFunc(\"/sse\", func (w http.ResponseWriter r *http.Request) {\n        l := n.NewListener()\n        defer l.Cleanup()\n\n        sse := sse.NewSSEWriter(w)\n        sse.WriteHeaders()\n\n        initial, err := playback.WaitForClient().PlayerCurrentlyPlaying(context.Background())\n        if err != nil {\n            http.Error(w, \"failed to fetch spotify data\")\n            return\n        }\n\n        sse.WriteEvent(\"initial\", initial)\n\n    loop:\n        for {\n            select {\n            case \u003C- w.(http.CloseNotifier).CloseNotify():\n                break loop\n            case data, ok := l.Ch:\n                if !ok {\n                    break loop\n                }\n\n                sse.WriteEvent(\"update\", data)\n                time.Sleep(2 * time.Second)\n            }\n        }\n    })\n\n    if err := http.ListenAndServe(\":3000\", mux); err != nil {\n        log.Fatal(err)\n    }\n}\n```\n\nSo what's going on here? When I first watched [the keynote Golang team gave about `select` in the context of channels](https://www.youtube.com/watch?v=QDDwwePbDtw) I was kinda blown away. Here, we wait in a loop for one of two possible events. The first event that could happen is we could receive a value from the `CloseNotify()` channel which will send exactly one message over the channel if the writer is closed (i.e. the user disconnects). We handle this case by breaking out of the loop and letting the deferred cleanup code run. We are also listening for data coming over the `l.Ch` channel and handling it by forwarding it to the sse writer.\n\n> update: in between developing this and writing this post, `CloseNotify` was deprecated in favor of `\u003C-r.Context().Done()` so use that if you're copying me I guess. Just don't flame me is what I'm trying to say. I'm just a little guy after all.\n\nNow this _works_, but it isn't super performant and to be honest, it's kinda cringe. The **vast** majority of times, I will either not be listening to a song, or I'll be listening to a song and the only thing that changed was my position in the song's duration, however that change can be predicted by the client. In reality, the server really only needs to send updates if current song changed to or from `nil`, play/pause state changed, the song itself changed, or the difference in position of the current song changed more than the time between the last poll event.\n\nTo incorporate these changes, I first needed to keep track of the previous state for us to compare the new current listening data against, since we only want to emit data if we absolutely have to. We also should keep track of the time when the last poll was run.\n\n```go file=internal/playback/notifier.go\ntype Notifier struct {\n    // [!code ++:2]\n    prev_data   *libspot.CurrentPlaying\n    prev_time   time.Time\n\tlisteners   []Listener\n}\n```\n\nThen, I updated the notifier logic accordingly\n\n```go file=internal/playback/notifier.go\nfunc (n *Notifier) Run() {\n    client := WaitForClient()\n\n    for {\n        // [!code ++:1]\n        func() {\n            data, err := client.PlayerCurrentlyPlaying(context.Background())\n            if err != nil {\n                log.Printf(\"Failed to poll playback: %v\", err)\n                time.Sleep(5 * time.Second)\n                return\n            }\n\n            // [!code ++:22]\n            if n.prev_data == nil {\n\t\t\t\tn.prev_data = data\n\t\t\t\tn.prev_time = time.Now()\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tcur_time := time.Now()\n\t\t\tprogress_delta_sec := (data.Progress / 1000) - (n.prev_data.Progress / 1000)\n\t\t\ttime_delta_sec := cur_time.Unix() - n.prev_time.Unix()\n\n            // under normal playback, the song’s progress should advance roughly one second per second\n            // any meaningful deviation from that implies a pause, seek, or track change\n\t\t\tjitter := math.Abs(float64(progress_delta_sec - libspot.Numeric(time_delta_sec)))\n\n            // [!code ++:25]\n\t\t\tdefer func() {\n\t\t\t\tn.prev_data = data\n\t\t\t\tn.prev_time = cur_time\n\n\t\t\t\ttime.Sleep(2 * time.Second)\n\t\t\t}()\n\n            if jitter > 1 {\n                n.notifyAll(data)\n                return\n            }\n\n\t\t\tif n.prev_data.Item == nil || data.Item == nil {\n                n.notifyAll(data)\n\t\t\t\treturn\n\t\t\t}\n\n            if n.prev_data.Item.Name != data.Item.Name {\n                n.notifyAll(data)\n                return\n            }\n\n            if n.prev_data.Playing != data.Playing {\n                n.notifyAll(data)\n            }\n\n            // [!code --:1]\n            n.notifyAll(data)\n            // [!code ++:1]\n        }()\n    }\n}\n```\n\nOkay cool! This approach worked fairly well. So next up was creating a client to connect to this service for my site. Astro lets us use whichever web framework we want for dynamic client stuff like this, but since I'm fairly react-pilled from work I decided to just roll with that.\n\n## Go go gadget web developer\n\nI first, like any good React developer, created a [zod](https://npmjs.com/package/zod) schema to validate the shape of the incoming Spotify API data. Because I was lazy in the server, this data is 1:1 with the shape that the Spotify API gives us. I probably shouldn't do it this way, but there's no one around to stop me. Now, this isn't how I want to represent our data in state, especially because SSE updates aren't the only thing that will be causing state updates. So we also construct a `Song` state shape.\n\n```tsx file=src/components/Player.tsx\nimport { z } from \"zod\";\n\ntype Song = {\n  href: string;\n  title: string;\n  artists: {\n    name: string;\n    href: string;\n  }[];\n  image?: string;\n  time: {\n    cursor: number;\n    duration: number;\n  };\n};\n\nconst zUpdateSchema = z.object({\n  is_playing: z.boolean(),\n  progress_ms: z.number(),\n  item: z.object({\n    duration_ms: z.number(),\n    name: z.string(),\n    href: z.string(),\n    external_urls: z.object({ spotify: z.string() }),\n    album: z.object({\n      images: z\n        .object({\n          height: z.number(),\n          width: z.number(),\n          url: z.string(),\n        })\n        .array(),\n    }),\n    artists: z\n      .object({\n        name: z.string(),\n        href: z.string(),\n      })\n      .array(),\n  }),\n});\n```\n\nThe rest of this is fairly trivial. We create two `useEffects`-- one to handle the SSE events, and one to handle moving the progress bar if the song is playing.\n\n```tsx file=src/components/Player.tsx\nimport { z } from \"astro/zod\";\nimport { useEffect, useState } from \"react\";\nimport { clsx } from \"clsx\";\nimport IconPauseUrl from \"@/assets/icons/IconPause.svg?url\";\n\nexport const Player = () => {\n  const [song, setSong] = useState\u003CSong | null>(null);\n  const [isPlaying, setIsPlaying] = useState(false);\n\n  useEffect(() => {\n    const interval = setInterval(() => {\n      if (!song || !isPlaying) return;\n      setSong({\n        ...song,\n        time: { duration: song.time.duration, cursor: song.time.cursor + 500 },\n      });\n    }, 500);\n\n    return () => {\n      clearInterval(interval);\n    };\n  }, [song, isPlaying]);\n\n  useEffect(() => {\n    const source = new EventSource(\"https://spotipub.holewinski.dev/sse\");\n\n    function ondata(evt: MessageEvent) {\n      const payload = zUpdateSchema.safeParse(JSON.parse(evt.data));\n\n      if (!payload.success) {\n        setSong(null);\n        return;\n      }\n\n      setIsPlaying(payload.data.is_playing);\n\n      setSong({\n        title: payload.data.item.name,\n        artists: payload.data.item.artists,\n        href: payload.data.item.external_urls.spotify,\n        image: payload.data.item.album.images\n          .toSorted((a, b) => b.height - a.height)\n          .at(0)?.url,\n        time: {\n          cursor: payload.data.progress_ms,\n          duration: payload.data.item.duration_ms,\n        },\n      });\n    }\n\n    source.addEventListener(\"initial\", ondata);\n    source.addEventListener(\"update\", ondata);\n\n    return () => {\n      source.removeEventListener(\"initial\", ondata);\n      source.removeEventListener(\"update\", ondata);\n    };\n  }, []);\n\n  if (!song) return null;\n\n  return (\n    \u003Cdiv className=\"mt-6 w-full rounded-md border-1 border-foreground bg-background p-2 sm:w-[300px]\">\n      \u003Cdiv className=\"flex gap-2\">\n        \u003Cdiv className=\"relative aspect-square h-14 w-14\">\n          {!isPlaying && (\n            \u003Cobject\n              className=\"absolute top-1/2 right-1/2 z-10 translate-x-1/2 -translate-y-1/2\"\n              data={IconPauseUrl}\n            />\n          )}\n          \u003Cimg\n            className={clsx(\n              \"absolute top-0 left-0 aspect-square h-14 w-14 rounded-sm\",\n              !isPlaying && \"opacity-15\"\n            )}\n            src={song.image}\n          />\n        \u003C/div>\n\n        \u003Cdiv className=\"flex flex-col truncate\">\n          \u003Cspan className=\"text-xs opacity-80\">Listening to\u003C/span>\n\n          \u003Ca\n            href={song.href}\n            className=\"text-sm decoration-dashed hover:underline\"\n          >\n            {song.title}\n          \u003C/a>\n\n          \u003Cdiv className=\"flex gap-2 [&>*:not(:last-child):after]:content-[',']\">\n            {song.artists.map(a => (\n              \u003Ca\n                href={a.href}\n                className=\"text-xs decoration-dashed hover:underline\"\n              >\n                {a.name}\n              \u003C/a>\n            ))}\n          \u003C/div>\n        \u003C/div>\n      \u003C/div>\n\n      \u003Cdiv className=\"mt-2 h-1 w-full rounded-full border-1 border-foreground\">\n        \u003Cdiv\n          className=\"h-0.5 rounded-full bg-foreground transition-all duration-300 ease-linear\"\n          style={{\n            width: `${(song.time.cursor / song.time.duration) * 100}%`,\n          }}\n        >\u003C/div>\n      \u003C/div>\n    \u003C/div>\n  );\n};\n```\n\nWe use tailwind of course to fully embrace the techbro hypebeast stack. Although sometimes when I hit tailwind with stuff like `[&>*:not(:last-child):after]:content-[',']`, which translates to\n\n```css\n& > *:not(:last-child):after {\n  content: \",\";\n}\n```\n\nI do die a little inside and wonder how we as an industry got here with this syntax. Then I remember how we got here, and I feel even bleaker. Although I blame CSS more than tailwind for this, I figured I would at least call it out as equal parts nifty and goofy.\n\n...well, perhaps not _equal_ parts.\n\nWe can just drop this component into our astro file with a [`client:load` directive](https://docs.astro.build/en/reference/directives-reference/#client-directives) since this widget appearing will cause a bit of layout shift. This isn't ideal and I'm still working on finding a way to better handle this case, but for now it's decent enough.\n\n```astro file=src/pages/index.astro\n\u003Cdiv class=\"flex w-full justify-end\">\n  \u003CPlayer client:load />\n\u003C/div>\n```\n\nAnd voila! I have a cute little Discord-style Spotify presence widget on my homepage.\n\n![player widget](../../assets/images/spotipub-widget.png)\n\nNow, when strangers come say hi and visit my site, they'll get that same tiny window into me that I always loved having into those around me.","src/data/posts/spotipub.md",[55],"../../assets/images/spotipub-widget.png","b155ea7b6d8a7be5",{"html":58,"metadata":59},"\u003Cp>So I’m not fully sure why, but I’ve always been big into music. It’s a big part of who I am and I love sharing it with the world! I really loved Discord’s Spotify integration feature that lets users share not just what they’re listening to, but also where in the track they are.\u003C/p>\n\u003Cp>I have memories of seeing what my classmates were listening to and just getting a vibe for who people were that way. It was nifty to be in a server with a couple dozen strangers, and their miniplayers next to their name.\u003C/p>\n\u003Cp>So when it came time to build out my own personal website, I thought it would be a nice touch if the strangers who visited found me, a stranger, with a miniplayer next to my name. Plus, if Discord integrated with Spotify then they must support it, right?\u003C/p>\n\u003Cp>…right?\u003C/p>\n\u003Ch2 id=\"table-of-contents\">Table of Contents\u003C/h2>\n\u003Cp>\u003C/p>\u003Cdetails>\u003Csummary>Open Table of Contents\u003C/summary>\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#so-i-looked-into-the-spotify-api-and\">So I looked into the Spotify API and…\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#sse-i-havent-heard-of-that-before-what-is-it\">SSE? I haven’t heard of that before what is it?\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#how-it-sort-of-works\">How it sort of works\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#go-go-gadget-web-developer\">Go go gadget web developer\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>\u003C/p>\u003C/details>\u003Cp>\u003C/p>\n\u003Ch2 id=\"so-i-looked-into-the-spotify-api-and\">So I looked into the Spotify API and…\u003C/h2>\n\u003Cp>They don’t! At least not for you and me. It turns out they don’t support websockets?? or \u003Cem>anything\u003C/em> real-time it seems. Spotify \u003Ca href=\"https://community.spotify.com/t5/Spotify-for-Developers/Retrieve-song-through-websocket/td-p/5182782\">has a partnership with discord to support this feature, but they do not expose it to regular developer accounts\u003C/a>.\u003C/p>\n\u003Cp>I figured, however, it wouldn’t be that challenging to just create a service that internally polled the current song endpoint and then pushed any relevant updates to connected clients over some sort of real-time protocol. I’ve been wanting to mess with \u003Ca href=\"https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events\">server sent events\u003C/a> for a while now and took this as an opportunity to finally do something with them.\u003C/p>\n\u003Ch2 id=\"sse-i-havent-heard-of-that-before-what-is-it\">SSE? I haven’t heard of that before what is it?\u003C/h2>\n\u003Cp>Websockets have a robust lifecycle that requires additional overhead and architecture to support its bidirectional communication functionalities. Server-sent Events, however, are UNIdirectional (as the name implies, its \u003Ccode>server -> client\u003C/code> only). Setting up a SSE connection is as simple as a client making a \u003Ccode>GET\u003C/code> request, and then responding with a \u003Ccode>content-type\u003C/code> of \u003Ccode>text/event-stream\u003C/code>. Then, the server simply periodically sends plain text data in the format of\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>event:eventname\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>data:{\"hello\":\"world\"}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\\n\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\\n\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>and that’s it! SSE functionality is built into native browser functionality with the \u003Ca href=\"https://developer.mozilla.org/en-US/docs/Web/API/EventSource\">EventSource API\u003C/a>.\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"js\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> es \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#E67E80\"> new\u003C/span>\u003Cspan style=\"color:#A7C080\"> EventSource\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"https://myserver.com/path\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">es\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">addEventListener\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"eventname\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, data \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  console\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">log\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(data); \u003C/span>\u003Cspan style=\"color:#859289;font-style:italic\">// &#x3C;- data is { hello: \"world\" }!\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">});\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">client.js\u003C/span>\u003C/pre>\n\u003Cp>It’s so simple I implemented the server logic for it in just under \u003Ca href=\"https://github.com/erwijet/spotipub/blob/main/internal/sse/sse_writer.go\">40 lines\u003C/a>, and I’m by no means a golang wizard so I’m sure there’s an even easier implementation out there.\u003C/p>\n\u003Cp>I also kinda wanted a chance to play with golang channels / goroutines for no other reason than I think they’re a really cool language feature and I haven’t really had a solid use case for them yet, so I decided to build this project around them.\u003C/p>\n\u003Ch2 id=\"how-it-sort-of-works\">How it sort of works\u003C/h2>\n\u003Cp>I used \u003Ca href=\"https://github.com/zmb3/spotify\">this excellent Spotify API library\u003C/a> for the actual interfacing with Spotify. What’s nice about this is it gives us an existing data struct representing the Spotify current listening data \u003Ccode>libspot.CurrentPlaying\u003C/code>.\u003C/p>\n\u003Cp>I first created a simple \u003Ccode>Listener\u003C/code> structure which wrapped a \u003Ccode>chan *libspot.CurrentPlaying\u003C/code> for us to send updates through. When a user connects to our \u003Ccode>/sse\u003C/code> endpoint, I create a new listener struct for their session and register it to a global \u003Ccode>Notifier\u003C/code> singleton.\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"go\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">type\u003C/span>\u003Cspan style=\"color:#7FBBB3\"> Notifier\u003C/span>\u003Cspan style=\"color:#E67E80\"> struct\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">\tlisteners []\u003C/span>\u003Cspan style=\"color:#7FBBB3\">Listener\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">func\u003C/span>\u003Cspan style=\"color:#D3C6AA\">  (n \u003C/span>\u003Cspan style=\"color:#E69875\">*\u003C/span>\u003Cspan style=\"color:#7FBBB3\">Notifier\u003C/span>\u003Cspan style=\"color:#D3C6AA\">) \u003C/span>\u003Cspan style=\"color:#A7C080\">NewListener\u003C/span>\u003Cspan style=\"color:#D3C6AA\">() \u003C/span>\u003Cspan style=\"color:#E69875\">*\u003C/span>\u003Cspan style=\"color:#7FBBB3\">Listener\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289;font-style:italic\">    // -- snip --\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">func\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (n \u003C/span>\u003Cspan style=\"color:#E69875\">*\u003C/span>\u003Cspan style=\"color:#7FBBB3\">Notifier\u003C/span>\u003Cspan style=\"color:#D3C6AA\">) \u003C/span>\u003Cspan style=\"color:#A7C080\">Cleanup\u003C/span>\u003Cspan style=\"color:#D3C6AA\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289;font-style:italic\">    // -- snip --\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">type\u003C/span>\u003Cspan style=\"color:#7FBBB3\"> Listener\u003C/span>\u003Cspan style=\"color:#E67E80\"> struct\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">\towner \u003C/span>\u003Cspan style=\"color:#E69875\">*\u003C/span>\u003Cspan style=\"color:#7FBBB3\">Notifier\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">\tCh    \u003C/span>\u003Cspan style=\"color:#E67E80\">chan\u003C/span>\u003Cspan style=\"color:#E69875\"> *\u003C/span>\u003Cspan style=\"color:#7FBBB3\">libspot\u003C/span>\u003Cspan style=\"color:#D3C6AA\">.\u003C/span>\u003Cspan style=\"color:#7FBBB3\">CurrentlyPlaying\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">}\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">internal/playback/notifier.go\u003C/span>\u003C/pre>\n\u003Cp>I then created a primary background goroutine for the \u003Ccode>Notifier\u003C/code> to poll Spotify. The initial implementation of this would just always forward that data to any connected client.\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"go\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">func\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (n \u003C/span>\u003Cspan style=\"color:#E69875\">*\u003C/span>\u003Cspan style=\"color:#7FBBB3\">Notifier\u003C/span>\u003Cspan style=\"color:#D3C6AA\">) \u003C/span>\u003Cspan style=\"color:#A7C080\">notifyAll\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(data \u003C/span>\u003Cspan style=\"color:#E69875\">*\u003C/span>\u003Cspan style=\"color:#7FBBB3\">libspot\u003C/span>\u003Cspan style=\"color:#D3C6AA\">.\u003C/span>\u003Cspan style=\"color:#7FBBB3\">CurrentlyPlaying\u003C/span>\u003Cspan style=\"color:#D3C6AA\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">    for\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> _, l \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#E67E80\"> range\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> n.listeners {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">        go\u003C/span>\u003Cspan style=\"color:#E67E80\"> func\u003C/span>\u003Cspan style=\"color:#D3C6AA\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">            l.Ch \u003C/span>\u003Cspan style=\"color:#E69875\">&#x3C;-\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> data\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">func\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (n \u003C/span>\u003Cspan style=\"color:#E69875\">*\u003C/span>\u003Cspan style=\"color:#7FBBB3\">Notifier\u003C/span>\u003Cspan style=\"color:#D3C6AA\">) \u003C/span>\u003Cspan style=\"color:#A7C080\">Run\u003C/span>\u003Cspan style=\"color:#D3C6AA\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    client \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#A7C080\"> WaitForClient\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">    for\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        data, err \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> client.\u003C/span>\u003Cspan style=\"color:#A7C080\">PlayerCurrentlyPlaying\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(context.\u003C/span>\u003Cspan style=\"color:#A7C080\">Background\u003C/span>\u003Cspan style=\"color:#D3C6AA\">())\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">        if\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> err \u003C/span>\u003Cspan style=\"color:#E69875\">!=\u003C/span>\u003Cspan style=\"color:#D699B6\"> nil\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">            log.\u003C/span>\u003Cspan style=\"color:#A7C080\">Printf\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"Failed to poll playback: \u003C/span>\u003Cspan style=\"color:#A7C080\">%v\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, err)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">            time.\u003C/span>\u003Cspan style=\"color:#A7C080\">Sleep\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#D699B6\">5\u003C/span>\u003Cspan style=\"color:#E69875\"> *\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> time.Second)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">            return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        n.\u003C/span>\u003Cspan style=\"color:#A7C080\">notifyAll\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">}\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">internal/playback/notifier.go\u003C/span>\u003C/pre>\n\u003Cp>Now there is a case where because we are just always firing into \u003Ccode>l.Ch\u003C/code> and aren’t buffering anything, things could get a bit blocked. However, I’m comfortable with this tradeoff because of the scale of this project and number of active sessions I’m expecting to have.\u003C/p>\n\u003Cp>I also went through and added an auth flow to initialize the shared Spotify API client object, but that’s not super interesting so I’ll omit much of it from this. I had a basic working implementation\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"go\">\u003Ccode>\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">func\u003C/span>\u003Cspan style=\"color:#A7C080\"> main\u003C/span>\u003Cspan style=\"color:#D3C6AA\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    n \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> playback.\u003C/span>\u003Cspan style=\"color:#A7C080\">NewNotifier\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    mux \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> http.\u003C/span>\u003Cspan style=\"color:#A7C080\">NewServeMux\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">    go\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> n.\u003C/span>\u003Cspan style=\"color:#A7C080\">Run\u003C/span>\u003Cspan style=\"color:#D3C6AA\">() \u003C/span>\u003Cspan style=\"color:#859289;font-style:italic\">// this runs our loop in the background\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    playback.\u003C/span>\u003Cspan style=\"color:#A7C080\">BeginAuthFlow\u003C/span>\u003Cspan style=\"color:#D3C6AA\">() \u003C/span>\u003Cspan style=\"color:#859289;font-style:italic\">// again, don't worry about this\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    mux.\u003C/span>\u003Cspan style=\"color:#A7C080\">HandleFunc\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"/sse\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, \u003C/span>\u003Cspan style=\"color:#E67E80\">func\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (w http.ResponseWriter r \u003C/span>\u003Cspan style=\"color:#E69875\">*\u003C/span>\u003Cspan style=\"color:#D3C6AA\">http.Request) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        l \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> n.\u003C/span>\u003Cspan style=\"color:#A7C080\">NewListener\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">        defer\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> l.\u003C/span>\u003Cspan style=\"color:#A7C080\">Cleanup\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        sse \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> sse.\u003C/span>\u003Cspan style=\"color:#A7C080\">NewSSEWriter\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(w)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        sse.\u003C/span>\u003Cspan style=\"color:#A7C080\">WriteHeaders\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        initial, err \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> playback.\u003C/span>\u003Cspan style=\"color:#A7C080\">WaitForClient\u003C/span>\u003Cspan style=\"color:#D3C6AA\">().\u003C/span>\u003Cspan style=\"color:#A7C080\">PlayerCurrentlyPlaying\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(context.\u003C/span>\u003Cspan style=\"color:#A7C080\">Background\u003C/span>\u003Cspan style=\"color:#D3C6AA\">())\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">        if\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> err \u003C/span>\u003Cspan style=\"color:#E69875\">!=\u003C/span>\u003Cspan style=\"color:#D699B6\"> nil\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">            http.\u003C/span>\u003Cspan style=\"color:#A7C080\">Error\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(w, \u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"failed to fetch spotify data\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">            return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        sse.\u003C/span>\u003Cspan style=\"color:#A7C080\">WriteEvent\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"initial\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, initial)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    loop:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">        for\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">            select\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">            case\u003C/span>\u003Cspan style=\"color:#E69875\"> &#x3C;-\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> w.(\u003C/span>\u003Cspan style=\"color:#7FBBB3\">http\u003C/span>\u003Cspan style=\"color:#D3C6AA\">.\u003C/span>\u003Cspan style=\"color:#7FBBB3\">CloseNotifier\u003C/span>\u003Cspan style=\"color:#D3C6AA\">).\u003C/span>\u003Cspan style=\"color:#A7C080\">CloseNotify\u003C/span>\u003Cspan style=\"color:#D3C6AA\">():\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">                break\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> loop\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">            case\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> data, ok \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> l.Ch:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">                if\u003C/span>\u003Cspan style=\"color:#E69875\"> !\u003C/span>\u003Cspan style=\"color:#D3C6AA\">ok {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">                    break\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> loop\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">                sse.\u003C/span>\u003Cspan style=\"color:#A7C080\">WriteEvent\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"update\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">                time.\u003C/span>\u003Cspan style=\"color:#A7C080\">Sleep\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#D699B6\">2\u003C/span>\u003Cspan style=\"color:#E69875\"> *\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> time.Second)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">    if\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> err \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> http.\u003C/span>\u003Cspan style=\"color:#A7C080\">ListenAndServe\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\":3000\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, mux); err \u003C/span>\u003Cspan style=\"color:#E69875\">!=\u003C/span>\u003Cspan style=\"color:#D699B6\"> nil\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        log.\u003C/span>\u003Cspan style=\"color:#A7C080\">Fatal\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(err)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">}\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">main.go\u003C/span>\u003C/pre>\n\u003Cp>So what’s going on here? When I first watched \u003Ca href=\"https://www.youtube.com/watch?v=QDDwwePbDtw\">the keynote Golang team gave about \u003Ccode>select\u003C/code> in the context of channels\u003C/a> I was kinda blown away. Here, we wait in a loop for one of two possible events. The first event that could happen is we could receive a value from the \u003Ccode>CloseNotify()\u003C/code> channel which will send exactly one message over the channel if the writer is closed (i.e. the user disconnects). We handle this case by breaking out of the loop and letting the deferred cleanup code run. We are also listening for data coming over the \u003Ccode>l.Ch\u003C/code> channel and handling it by forwarding it to the sse writer.\u003C/p>\n\u003Cblockquote>\n\u003Cp>update: in between developing this and writing this post, \u003Ccode>CloseNotify\u003C/code> was deprecated in favor of \u003Ccode>&#x3C;-r.Context().Done()\u003C/code> so use that if you’re copying me I guess. Just don’t flame me is what I’m trying to say. I’m just a little guy after all.\u003C/p>\n\u003C/blockquote>\n\u003Cp>Now this \u003Cem>works\u003C/em>, but it isn’t super performant and to be honest, it’s kinda cringe. The \u003Cstrong>vast\u003C/strong> majority of times, I will either not be listening to a song, or I’ll be listening to a song and the only thing that changed was my position in the song’s duration, however that change can be predicted by the client. In reality, the server really only needs to send updates if current song changed to or from \u003Ccode>nil\u003C/code>, play/pause state changed, the song itself changed, or the difference in position of the current song changed more than the time between the last poll event.\u003C/p>\n\u003Cp>To incorporate these changes, I first needed to keep track of the previous state for us to compare the new current listening data against, since we only want to emit data if we absolutely have to. We also should keep track of the time when the last poll was run.\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark has-diff mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"go\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">type\u003C/span>\u003Cspan style=\"color:#7FBBB3\"> Notifier\u003C/span>\u003Cspan style=\"color:#E67E80\"> struct\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">    prev_data   \u003C/span>\u003Cspan style=\"color:#E69875\">*\u003C/span>\u003Cspan style=\"color:#7FBBB3\">libspot\u003C/span>\u003Cspan style=\"color:#D3C6AA\">.\u003C/span>\u003Cspan style=\"color:#7FBBB3\">CurrentPlaying\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">    prev_time   \u003C/span>\u003Cspan style=\"color:#7FBBB3\">time\u003C/span>\u003Cspan style=\"color:#D3C6AA\">.\u003C/span>\u003Cspan style=\"color:#7FBBB3\">Time\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">\tlisteners   []\u003C/span>\u003Cspan style=\"color:#7FBBB3\">Listener\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">}\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">internal/playback/notifier.go\u003C/span>\u003C/pre>\n\u003Cp>Then, I updated the notifier logic accordingly\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark has-diff mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"go\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">func\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (n \u003C/span>\u003Cspan style=\"color:#E69875\">*\u003C/span>\u003Cspan style=\"color:#7FBBB3\">Notifier\u003C/span>\u003Cspan style=\"color:#D3C6AA\">) \u003C/span>\u003Cspan style=\"color:#A7C080\">Run\u003C/span>\u003Cspan style=\"color:#D3C6AA\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    client \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#A7C080\"> WaitForClient\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">    for\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E67E80\">        func\u003C/span>\u003Cspan style=\"color:#D3C6AA\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">            data, err \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> client.\u003C/span>\u003Cspan style=\"color:#A7C080\">PlayerCurrentlyPlaying\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(context.\u003C/span>\u003Cspan style=\"color:#A7C080\">Background\u003C/span>\u003Cspan style=\"color:#D3C6AA\">())\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">            if\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> err \u003C/span>\u003Cspan style=\"color:#E69875\">!=\u003C/span>\u003Cspan style=\"color:#D699B6\"> nil\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">                log.\u003C/span>\u003Cspan style=\"color:#A7C080\">Printf\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"Failed to poll playback: \u003C/span>\u003Cspan style=\"color:#A7C080\">%v\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, err)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">                time.\u003C/span>\u003Cspan style=\"color:#A7C080\">Sleep\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#D699B6\">5\u003C/span>\u003Cspan style=\"color:#E69875\"> *\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> time.Second)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">                return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E67E80\">            if\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> n.prev_data \u003C/span>\u003Cspan style=\"color:#E69875\">==\u003C/span>\u003Cspan style=\"color:#D699B6\"> nil\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">\t\t\t\tn.prev_data \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> data\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">\t\t\t\tn.prev_time \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> time.\u003C/span>\u003Cspan style=\"color:#A7C080\">Now\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E67E80\">\t\t\t\treturn\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">\t\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">\t\t\tcur_time \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> time.\u003C/span>\u003Cspan style=\"color:#A7C080\">Now\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">\t\t\tprogress_delta_sec \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (data.Progress \u003C/span>\u003Cspan style=\"color:#E69875\">/\u003C/span>\u003Cspan style=\"color:#D699B6\"> 1000\u003C/span>\u003Cspan style=\"color:#D3C6AA\">) \u003C/span>\u003Cspan style=\"color:#E69875\">-\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (n.prev_data.Progress \u003C/span>\u003Cspan style=\"color:#E69875\">/\u003C/span>\u003Cspan style=\"color:#D699B6\"> 1000\u003C/span>\u003Cspan style=\"color:#D3C6AA\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">\t\t\ttime_delta_sec \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> cur_time.\u003C/span>\u003Cspan style=\"color:#A7C080\">Unix\u003C/span>\u003Cspan style=\"color:#D3C6AA\">() \u003C/span>\u003Cspan style=\"color:#E69875\">-\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> n.prev_time.\u003C/span>\u003Cspan style=\"color:#A7C080\">Unix\u003C/span>\u003Cspan style=\"color:#D3C6AA\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#859289;font-style:italic\">            // under normal playback, the song’s progress should advance roughly one second per second\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#859289;font-style:italic\">            // any meaningful deviation from that implies a pause, seek, or track change\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">\t\t\tjitter \u003C/span>\u003Cspan style=\"color:#E69875\">:=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> math.\u003C/span>\u003Cspan style=\"color:#A7C080\">Abs\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#7FBBB3\">float64\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(progress_delta_sec \u003C/span>\u003Cspan style=\"color:#E69875\">-\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> libspot.\u003C/span>\u003Cspan style=\"color:#A7C080\">Numeric\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(time_delta_sec)))\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E67E80\">\t\t\tdefer\u003C/span>\u003Cspan style=\"color:#E67E80\"> func\u003C/span>\u003Cspan style=\"color:#D3C6AA\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">\t\t\t\tn.prev_data \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> data\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">\t\t\t\tn.prev_time \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> cur_time\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">\t\t\t\ttime.\u003C/span>\u003Cspan style=\"color:#A7C080\">Sleep\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#D699B6\">2\u003C/span>\u003Cspan style=\"color:#E69875\"> *\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> time.Second)\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">\t\t\t}()\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E67E80\">            if\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> jitter \u003C/span>\u003Cspan style=\"color:#E69875\">>\u003C/span>\u003Cspan style=\"color:#D699B6\"> 1\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">                n.\u003C/span>\u003Cspan style=\"color:#A7C080\">notifyAll\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E67E80\">                return\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E67E80\">\t\t\tif\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> n.prev_data.Item \u003C/span>\u003Cspan style=\"color:#E69875\">==\u003C/span>\u003Cspan style=\"color:#D699B6\"> nil\u003C/span>\u003Cspan style=\"color:#E69875\"> ||\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> data.Item \u003C/span>\u003Cspan style=\"color:#E69875\">==\u003C/span>\u003Cspan style=\"color:#D699B6\"> nil\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">                n.\u003C/span>\u003Cspan style=\"color:#A7C080\">notifyAll\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E67E80\">\t\t\t\treturn\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">\t\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E67E80\">            if\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> n.prev_data.Item.Name \u003C/span>\u003Cspan style=\"color:#E69875\">!=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> data.Item.Name {\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">                n.\u003C/span>\u003Cspan style=\"color:#A7C080\">notifyAll\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E67E80\">                return\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#E67E80\">            if\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> n.prev_data.Playing \u003C/span>\u003Cspan style=\"color:#E69875\">!=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> data.Playing {\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">                n.\u003C/span>\u003Cspan style=\"color:#A7C080\">notifyAll\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line diff remove\">\u003Cspan style=\"color:#D3C6AA\">            n.\u003C/span>\u003Cspan style=\"color:#A7C080\">notifyAll\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line diff add\">\u003Cspan style=\"color:#D3C6AA\">        }()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">}\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">internal/playback/notifier.go\u003C/span>\u003C/pre>\n\u003Cp>Okay cool! This approach worked fairly well. So next up was creating a client to connect to this service for my site. Astro lets us use whichever web framework we want for dynamic client stuff like this, but since I’m fairly react-pilled from work I decided to just roll with that.\u003C/p>\n\u003Ch2 id=\"go-go-gadget-web-developer\">Go go gadget web developer\u003C/h2>\n\u003Cp>I first, like any good React developer, created a \u003Ca href=\"https://npmjs.com/package/zod\">zod\u003C/a> schema to validate the shape of the incoming Spotify API data. Because I was lazy in the server, this data is 1:1 with the shape that the Spotify API gives us. I probably shouldn’t do it this way, but there’s no one around to stop me. Now, this isn’t how I want to represent our data in state, especially because SSE updates aren’t the only thing that will be causing state updates. So we also construct a \u003Ccode>Song\u003C/code> state shape.\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"tsx\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">import\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> { z } \u003C/span>\u003Cspan style=\"color:#E67E80\">from\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"zod\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">type\u003C/span>\u003Cspan style=\"color:#83C092\"> Song\u003C/span>\u003Cspan style=\"color:#E69875\"> =\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  href\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#7FBBB3\"> string\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  title\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#7FBBB3\"> string\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  artists\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    name\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#7FBBB3\"> string\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    href\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#7FBBB3\"> string\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  }[];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  image\u003C/span>\u003Cspan style=\"color:#E69875\">?\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#7FBBB3\"> string\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  time\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    cursor\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#7FBBB3\"> number\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    duration\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#7FBBB3\"> number\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> zUpdateSchema \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">object\u003C/span>\u003Cspan style=\"color:#D3C6AA\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  is_playing\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">boolean\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  progress_ms\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">number\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  item\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">object\u003C/span>\u003Cspan style=\"color:#D3C6AA\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    duration_ms\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">number\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    name\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">string\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    href\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">string\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    external_urls\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">object\u003C/span>\u003Cspan style=\"color:#D3C6AA\">({ spotify\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">string\u003C/span>\u003Cspan style=\"color:#D3C6AA\">() }),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    album\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">object\u003C/span>\u003Cspan style=\"color:#D3C6AA\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">      images\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">        .\u003C/span>\u003Cspan style=\"color:#A7C080\">object\u003C/span>\u003Cspan style=\"color:#D3C6AA\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">          height\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">number\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">          width\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">number\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">          url\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">string\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">        .\u003C/span>\u003Cspan style=\"color:#A7C080\">array\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    }),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    artists\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">      .\u003C/span>\u003Cspan style=\"color:#A7C080\">object\u003C/span>\u003Cspan style=\"color:#D3C6AA\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        name\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">string\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        href\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> z\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">string\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">      })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">      .\u003C/span>\u003Cspan style=\"color:#A7C080\">array\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  }),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">});\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">src/components/Player.tsx\u003C/span>\u003C/pre>\n\u003Cp>The rest of this is fairly trivial. We create two \u003Ccode>useEffects\u003C/code>— one to handle the SSE events, and one to handle moving the progress bar if the song is playing.\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"tsx\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">import\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> { z } \u003C/span>\u003Cspan style=\"color:#E67E80\">from\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"astro/zod\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">import\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> { useEffect, useState } \u003C/span>\u003Cspan style=\"color:#E67E80\">from\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"react\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">import\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> { clsx } \u003C/span>\u003Cspan style=\"color:#E67E80\">from\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"clsx\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">import\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> IconPauseUrl \u003C/span>\u003Cspan style=\"color:#E67E80\">from\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"@/assets/icons/IconPause.svg?url\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D699B6\">export\u003C/span>\u003Cspan style=\"color:#E69875\"> const\u003C/span>\u003Cspan style=\"color:#A7C080\"> Player\u003C/span>\u003Cspan style=\"color:#E69875\"> =\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> () \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">  const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> [song, setSong] \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#A7C080\"> useState\u003C/span>\u003Cspan style=\"color:#D3C6AA\">&#x3C;\u003C/span>\u003Cspan style=\"color:#83C092\">Song\u003C/span>\u003Cspan style=\"color:#E69875\"> |\u003C/span>\u003Cspan style=\"color:#7FBBB3\"> null\u003C/span>\u003Cspan style=\"color:#D3C6AA\">>(\u003C/span>\u003Cspan style=\"color:#D699B6\">null\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">  const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> [isPlaying, setIsPlaying] \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#A7C080\"> useState\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#D699B6\">false\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">  useEffect\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(() \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">    const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> interval \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#A7C080\"> setInterval\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(() \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">      if\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (\u003C/span>\u003Cspan style=\"color:#E69875\">!\u003C/span>\u003Cspan style=\"color:#D3C6AA\">song \u003C/span>\u003Cspan style=\"color:#E69875\">||\u003C/span>\u003Cspan style=\"color:#E69875\"> !\u003C/span>\u003Cspan style=\"color:#D3C6AA\">isPlaying) \u003C/span>\u003Cspan style=\"color:#E67E80\">return\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">      setSong\u003C/span>\u003Cspan style=\"color:#D3C6AA\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">        ...\u003C/span>\u003Cspan style=\"color:#D3C6AA\">song,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        time\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> { duration\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> song\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">time\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">duration, cursor\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> song\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">time\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">cursor \u003C/span>\u003Cspan style=\"color:#E69875\">+\u003C/span>\u003Cspan style=\"color:#D699B6\"> 500\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">      });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    }, \u003C/span>\u003Cspan style=\"color:#D699B6\">500\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">    return\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> () \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">      clearInterval\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(interval);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  }, [song, isPlaying]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">  useEffect\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(() \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">    const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> source \u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#E67E80\"> new\u003C/span>\u003Cspan style=\"color:#A7C080\"> EventSource\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"https://spotipub.holewinski.dev/sse\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">    function\u003C/span>\u003Cspan style=\"color:#A7C080\"> ondata\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(evt\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#83C092\"> MessageEvent\u003C/span>\u003Cspan style=\"color:#D3C6AA\">)\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">      const\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> payload\u003C/span>\u003Cspan style=\"color:#E69875\"> =\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> zUpdateSchema\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">safeParse\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(JSON\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">parse\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(evt\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">data));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">      if\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (\u003C/span>\u003Cspan style=\"color:#E69875\">!\u003C/span>\u003Cspan style=\"color:#D3C6AA\">payload\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">success)\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">        setSong\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#D699B6\">null\u003C/span>\u003Cspan style=\"color:#D3C6AA\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">        return\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">      }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">      setIsPlaying\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(payload\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">data\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">is_playing);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">      setSong\u003C/span>\u003Cspan style=\"color:#D3C6AA\">({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        title\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> payload\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">data\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">item\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">name,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        artists\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> payload\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">data\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">item\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">artists,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        href\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> payload\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">data\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">item\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">external_urls\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">spotify,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        image\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> payload\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">data\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">item\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">album\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">images\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">          .\u003C/span>\u003Cspan style=\"color:#A7C080\">toSorted\u003C/span>\u003Cspan style=\"color:#D3C6AA\">((a,\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> b)\u003C/span>\u003Cspan style=\"color:#E69875\"> =>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> b\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">height\u003C/span>\u003Cspan style=\"color:#E69875\"> -\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> a\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">height)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#859289\">          .\u003C/span>\u003Cspan style=\"color:#A7C080\">at\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#D699B6\">0\u003C/span>\u003Cspan style=\"color:#D3C6AA\">)?.url,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        time\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">          cursor\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> payload\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">data\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">progress_ms,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">          duration\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> payload\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">data\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">item\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">duration_ms,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">      });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    source\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">addEventListener\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"initial\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, ondata);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    source\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">addEventListener\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"update\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, ondata);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">    return\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> () \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">      source\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">removeEventListener\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"initial\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, ondata);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">      source\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">removeEventListener\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"update\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">, ondata);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">    };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  }, []);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">  if\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (\u003C/span>\u003Cspan style=\"color:#E69875\">!\u003C/span>\u003Cspan style=\"color:#D3C6AA\">song) \u003C/span>\u003Cspan style=\"color:#E67E80\">return\u003C/span>\u003Cspan style=\"color:#D699B6\"> null\u003C/span>\u003Cspan style=\"color:#D3C6AA\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E67E80\">  return\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">    &#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\"> className\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"mt-6 w-full rounded-md border-1 border-foreground bg-background p-2 sm:w-[300px]\"\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">      &#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\"> className\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"flex gap-2\"\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">        &#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\"> className\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"relative aspect-square h-14 w-14\"\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">          {\u003C/span>\u003Cspan style=\"color:#E69875\">!\u003C/span>\u003Cspan style=\"color:#D3C6AA\">isPlaying \u003C/span>\u003Cspan style=\"color:#E69875\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">            &#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">object\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">              className\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"absolute top-1/2 right-1/2 z-10 translate-x-1/2 -translate-y-1/2\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">              data\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#A7C080\">{\u003C/span>\u003Cspan style=\"color:#D3C6AA\">IconPauseUrl\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">            />\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">          )\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">          &#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">img\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">            className\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#A7C080\">{clsx\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#DBBC7F\">              \"absolute top-0 left-0 aspect-square h-14 w-14 rounded-sm\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E69875\">              !\u003C/span>\u003Cspan style=\"color:#D3C6AA\">isPlaying \u003C/span>\u003Cspan style=\"color:#E69875\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> \"opacity-15\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">            )\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">            src\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#A7C080\">{\u003C/span>\u003Cspan style=\"color:#D3C6AA\">song\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">image\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">          />\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">        &#x3C;/\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">        &#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\"> className\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"flex flex-col truncate\"\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">          &#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">span\u003C/span>\u003Cspan style=\"color:#A7C080\"> className\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"text-xs opacity-80\"\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003Cspan style=\"color:#D3C6AA\">Listening to\u003C/span>\u003Cspan style=\"color:#A7C080\">&#x3C;/\u003C/span>\u003Cspan style=\"color:#E69875\">span\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">          &#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">a\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">            href\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#A7C080\">{\u003C/span>\u003Cspan style=\"color:#D3C6AA\">song\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">href\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">            className\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"text-sm decoration-dashed hover:underline\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">          >\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">            {\u003C/span>\u003Cspan style=\"color:#D3C6AA\">song\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">title\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">          &#x3C;/\u003C/span>\u003Cspan style=\"color:#E69875\">a\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">          &#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\"> className\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"flex gap-2 [&#x26;>*:not(:last-child):after]:content-[',']\"\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">            {\u003C/span>\u003Cspan style=\"color:#D3C6AA\">song\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">artists\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#A7C080\">map\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(a \u003C/span>\u003Cspan style=\"color:#E69875\">=>\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">              &#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">a\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">                href\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#A7C080\">{\u003C/span>\u003Cspan style=\"color:#D3C6AA\">a\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">href\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">                className\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"text-xs decoration-dashed hover:underline\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">              >\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">                {\u003C/span>\u003Cspan style=\"color:#D3C6AA\">a\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">name\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">              &#x3C;/\u003C/span>\u003Cspan style=\"color:#E69875\">a\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">            ))\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">          &#x3C;/\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">        &#x3C;/\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">      &#x3C;/\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">      &#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\"> className\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"mt-2 h-1 w-full rounded-full border-1 border-foreground\"\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">        &#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">          className\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"h-0.5 rounded-full bg-foreground transition-all duration-300 ease-linear\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">          style\u003C/span>\u003Cspan style=\"color:#E69875\">=\u003C/span>\u003Cspan style=\"color:#A7C080\">{\u003C/span>\u003Cspan style=\"color:#D3C6AA\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">            width\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> `\u003C/span>\u003Cspan style=\"color:#A7C080\">${\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(song\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">time\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">cursor\u003C/span>\u003Cspan style=\"color:#E69875\"> /\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> song\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">time\u003C/span>\u003Cspan style=\"color:#859289\">.\u003C/span>\u003Cspan style=\"color:#D3C6AA\">duration)\u003C/span>\u003Cspan style=\"color:#E69875\"> *\u003C/span>\u003Cspan style=\"color:#D699B6\"> 100\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003Cspan style=\"color:#DBBC7F\">%`\u003C/span>\u003Cspan style=\"color:#D3C6AA\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">          }\u003C/span>\u003Cspan style=\"color:#A7C080\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">        >&#x3C;/\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">      &#x3C;/\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#A7C080\">    &#x3C;/\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#A7C080\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  );\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">};\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">src/components/Player.tsx\u003C/span>\u003C/pre>\n\u003Cp>We use tailwind of course to fully embrace the techbro hypebeast stack. Although sometimes when I hit tailwind with stuff like \u003Ccode>[&#x26;>*:not(:last-child):after]:content-[',']\u003C/code>, which translates to\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"css\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">&#x26; \u003C/span>\u003Cspan style=\"color:#E69875\">>\u003C/span>\u003Cspan style=\"color:#E69875\"> *\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\">not\u003C/span>\u003Cspan style=\"color:#D3C6AA\">(\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\">last-child\u003C/span>\u003Cspan style=\"color:#D3C6AA\">)\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#DBBC7F\">after\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#83C092\">  content\u003C/span>\u003Cspan style=\"color:#859289\">:\u003C/span>\u003Cspan style=\"color:#A7C080\"> \",\"\u003C/span>\u003Cspan style=\"color:#859289\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>I do die a little inside and wonder how we as an industry got here with this syntax. Then I remember how we got here, and I feel even bleaker. Although I blame CSS more than tailwind for this, I figured I would at least call it out as equal parts nifty and goofy.\u003C/p>\n\u003Cp>…well, perhaps not \u003Cem>equal\u003C/em> parts.\u003C/p>\n\u003Cp>We can just drop this component into our astro file with a \u003Ca href=\"https://docs.astro.build/en/reference/directives-reference/#client-directives\">\u003Ccode>client:load\u003C/code> directive\u003C/a> since this widget appearing will cause a bit of layout shift. This isn’t ideal and I’m still working on finding a way to better handle this case, but for now it’s decent enough.\u003C/p>\n\u003Cpre class=\"astro-code everforest-dark mt-8\" style=\"background-color:#2d353b;color:#d3c6aa; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"astro\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> class\u003C/span>\u003Cspan style=\"color:#D3C6AA\">=\u003C/span>\u003Cspan style=\"color:#DBBC7F\">\"flex w-full justify-end\"\u003C/span>\u003Cspan style=\"color:#D3C6AA\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">  &#x3C;\u003C/span>\u003Cspan style=\"color:#7FBBB3\">Player\u003C/span>\u003Cspan style=\"color:#DBBC7F\"> client:load\u003C/span>\u003Cspan style=\"color:#D3C6AA\"> />\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#D3C6AA\">&#x3C;/\u003C/span>\u003Cspan style=\"color:#E69875\">div\u003C/span>\u003Cspan style=\"color:#D3C6AA\">>\u003C/span>\u003C/span>\u003C/code>\u003Cspan class=\"absolute py-1 text-foreground text-xs font-medium leading-4 pl-4 pr-2 before:inline-block before:size-1 before:bg-green-500 before:rounded-full before:absolute before:top-[45%] before:left-2 left-2 top-(--file-name-offset) border rounded-md bg-background\">src/pages/index.astro\u003C/span>\u003C/pre>\n\u003Cp>And voila! I have a cute little Discord-style Spotify presence widget on my homepage.\u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/images/spotipub-widget.png&#x22;,&#x22;alt&#x22;:&#x22;player widget&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>Now, when strangers come say hi and visit my site, they’ll get that same tiny window into me that I always loved having into those around me.\u003C/p>",{"headings":60,"localImagePaths":76,"remoteImagePaths":77,"frontmatter":78,"imagePaths":80},[61,64,67,70,73],{"depth":33,"slug":62,"text":63},"table-of-contents","Table of Contents",{"depth":33,"slug":65,"text":66},"so-i-looked-into-the-spotify-api-and","So I looked into the Spotify API and…",{"depth":33,"slug":68,"text":69},"sse-i-havent-heard-of-that-before-what-is-it","SSE? I haven’t heard of that before what is it?",{"depth":33,"slug":71,"text":72},"how-it-sort-of-works","How it sort of works",{"depth":33,"slug":74,"text":75},"go-go-gadget-web-developer","Go go gadget web developer",[55],[],{"author":14,"pubDatetime":79,"title":49,"slug":44,"featured":18,"draft":19,"description":51,"github":48},["Date","2025-10-05T03:52:58.281Z"],[55]]